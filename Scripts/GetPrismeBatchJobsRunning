USE AXDB;

DECLARE @COMPANY CHAR(4) = 'DAT'

SELECT 
 BJ.CAPTION,
 BJ.ORIGSTARTDATETIME,
 NULLIF(BJ.STARTDATETIME, '1900-01-01') AS STARTDATETIME,
 NULLIF(BJ.ENDDATETIME, '1900-01-01') AS ENDDATETIME,
 CASE BJ.STATUS
	WHEN 0 THEN 'Hold'
	WHEN 1 THEN 'Waiting'
	WHEN 2 THEN 'Executing'
	WHEN 3 THEN 'Error'
	WHEN 4 THEN 'Finishing'
	WHEN 5 THEN 'Ready'
	WHEN 6 THEN 'NotRun'
	WHEN 7 THEN 'Cancelling'
	WHEN 8 THEN 'Canceled'
	END AS STATUS ,
	IIF(BJ.STATUS IN(2,3,4,7,8), DATEDIFF(MINUTE,BJ.STARTDATETIME,COALESCE(NULLIF(BJ.ENDDATETIME, '1900-01-01'), GETDATE())), NULL) AS DURATION_MIN,
 NULLIF(BJ.BATCHGROUP, '') AS BATCHGROUP,
 BJ.RECID AS BATCHJOBID,
 BJ.EXECUTINGBY,
 BJ.COMPANY
FROM dbo.BATCHJOB AS BJ
WHERE BJ.ORIGSTARTDATETIME BETWEEN DATEADD(DAY, -7, GETDATE()) AND GETDATE()
--AND BJ.COMPANY <> @COMPANY
ORDER BY BJ.COMPANY, STARTDATETIME DESC

